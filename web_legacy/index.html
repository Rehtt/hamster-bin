<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µå­å…ƒä»¶åº“å­˜ç®¡ç†ç³»ç»Ÿ</title>
    <!-- Element Plus CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <!-- Element Plus Icons -->
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/style.css">
    <!-- HTML5 QR Code Scanner -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
        }

        #app {
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-title .icon {
            font-size: 32px;
        }

        .header-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .el-tabs {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
        }

        .toolbar {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-bar {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 800px;
        }

        .stock-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .stock-high {
            background: #f0f9ff;
            color: #0284c7;
        }

        .stock-medium {
            background: #fef3c7;
            color: #d97706;
        }

        .stock-low {
            background: #fee2e2;
            color: #dc2626;
        }

        .component-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }

        .no-image {
            width: 50px;
            height: 50px;
            background: #f3f4f6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .el-dialog__body {
            padding: 20px 30px;
        }

        .form-section {
            margin-bottom: 15px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 64px;
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .log-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            background: #f9fafb;
        }

        .log-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .log-in {
            background: #d1fae5;
            color: #065f46;
        }

        .log-out {
            background: #fee2e2;
            color: #991b1b;
        }

        .log-content {
            flex: 1;
        }

        .log-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .log-meta {
            font-size: 12px;
            color: #6b7280;
        }

        .category-tree {
            margin-top: 20px;
        }

        .qrcode-scanner {
            margin: 20px 0;
        }

        #qr-reader {
            border: 2px dashed #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        #qr-reader video {
            width: 100%;
            border-radius: 6px;
        }

        .scanner-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-bar {
                max-width: 100%;
            }

            /* å¯¹è¯æ¡†è‡ªé€‚åº” */
            .el-dialog {
                width: 95% !important;
                max-width: 95% !important;
            }

            .el-dialog__body {
                padding: 15px 15px;
            }

            /* å¹³å°å¯¼å…¥åŒºåŸŸè‡ªé€‚åº” */
            .platform-import-box {
                flex-direction: column;
                align-items: stretch !important;
            }
            
            .platform-import-box .el-button {
                width: 100%;
            }

            /* è¡¨å•æ ‡ç­¾è‡ªé€‚åº” */
            .el-form-item__label {
                float: none;
                display: block;
                text-align: left;
                padding: 0 0 8px;
            }
            
            .el-form-item__content {
                margin-left: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <div class="header">
            <div class="header-content">
                <div class="header-title">
                    <span class="icon">ğŸ“¦</span>
                    <h1>ç”µå­å…ƒä»¶åº“å­˜ç®¡ç†ç³»ç»Ÿ</h1>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ stats.totalComponents }}</div>
                        <div class="stat-label">å…ƒä»¶ç§ç±»</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ stats.totalStock }}</div>
                        <div class="stat-label">æ€»åº“å­˜</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ stats.categories }}</div>
                        <div class="stat-label">åˆ†ç±»æ•°é‡</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <el-tabs v-model="activeTab" type="border-card">
                <!-- å…ƒä»¶ç®¡ç† -->
                <el-tab-pane label="å…ƒä»¶ç®¡ç†" name="components">
                    <template #label>
                        <span><i class="el-icon-box"></i> å…ƒä»¶ç®¡ç†</span>
                    </template>

                    <div class="toolbar">
                        <div class="search-bar">
                            <el-input 
                                v-model="componentSearch.keyword" 
                                placeholder="æœç´¢å…ƒä»¶åç§°ã€å‹å·ã€æè¿°..." 
                                clearable
                                @clear="loadComponents"
                                @keyup.enter="loadComponents">
                                <template #prefix>
                                    <i class="el-icon-search"></i>
                                </template>
                            </el-input>
                            <el-select 
                                v-model="componentSearch.categoryId" 
                                placeholder="é€‰æ‹©åˆ†ç±»" 
                                clearable
                                @change="loadComponents"
                                style="width: 200px;">
                                <el-option 
                                    v-for="cat in categories" 
                                    :key="cat.id" 
                                    :label="cat.name" 
                                    :value="cat.id">
                                </el-option>
                            </el-select>
                            <el-button type="primary" @click="loadComponents">æœç´¢</el-button>
                        </div>
                        <el-button type="primary" @click="showComponentDialog(null)">
                            <i class="el-icon-plus"></i> æ·»åŠ å…ƒä»¶
                        </el-button>
                    </div>

                    <el-table 
                        :data="components" 
                        v-loading="loading"
                        stripe
                        style="width: 100%">
                        <el-table-column type="index" width="60" label="#"></el-table-column>
                        <el-table-column label="å›¾ç‰‡" width="80">
                            <template #default="scope">
                                <img v-if="scope.row.image_url" :src="scope.row.image_url" class="component-image">
                                <div v-else class="no-image">ğŸ“¦</div>
                            </template>
                        </el-table-column>
                        <el-table-column prop="name" label="åç§°" min-width="150"></el-table-column>
                        <el-table-column prop="value" label="å‚æ•°å€¼" width="100"></el-table-column>
                        <el-table-column prop="package" label="å°è£…" width="100"></el-table-column>
                        <el-table-column label="åˆ†ç±»" width="120">
                            <template #default="scope">
                                <el-tag v-if="scope.row.category" size="small">{{ scope.row.category.name }}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="åº“å­˜" width="120">
                            <template #default="scope">
                                <span :class="getStockClass(scope.row.stock_quantity)">
                                    {{ scope.row.stock_quantity }}
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="location" label="ä½ç½®" width="100"></el-table-column>
                        <el-table-column prop="description" label="æè¿°" min-width="150" show-overflow-tooltip></el-table-column>
                        <el-table-column label="æ“ä½œ" width="280" fixed="right">
                            <template #default="scope">
                                <el-button size="small" @click="showComponentDialog(scope.row)">ç¼–è¾‘</el-button>
                                <el-button size="small" type="success" @click="showStockDialog(scope.row)">åº“å­˜</el-button>
                                <el-button size="small" type="info" @click="showLogsDialog(scope.row)">è®°å½•</el-button>
                                <el-button size="small" type="danger" @click="deleteComponent(scope.row)">åˆ é™¤</el-button>
                            </template>
                        </el-table-column>
                    </el-table>

                    <el-pagination
                        v-if="componentPagination.total > 0"
                        @current-change="handlePageChange"
                        @size-change="handleSizeChange"
                        :current-page="componentPagination.page"
                        :page-sizes="[10, 20, 50, 100]"
                        :page-size="componentPagination.pageSize"
                        :total="componentPagination.total"
                        layout="total, sizes, prev, pager, next, jumper"
                        style="margin-top: 20px; text-align: right;">
                    </el-pagination>
                </el-tab-pane>

                <!-- åˆ†ç±»ç®¡ç† -->
                <el-tab-pane label="åˆ†ç±»ç®¡ç†" name="categories">
                    <template #label>
                        <span><i class="el-icon-folder"></i> åˆ†ç±»ç®¡ç†</span>
                    </template>

                    <div class="toolbar">
                        <div></div>
                        <el-button type="primary" @click="showCategoryDialog(null)">
                            <i class="el-icon-plus"></i> æ·»åŠ åˆ†ç±»
                        </el-button>
                    </div>

                    <el-table :data="categories" v-loading="loading" stripe style="width: 100%">
                        <el-table-column type="index" width="60" label="#"></el-table-column>
                        <el-table-column prop="name" label="åˆ†ç±»åç§°" min-width="200"></el-table-column>
                        <el-table-column prop="id" label="ID" width="80"></el-table-column>
                        <el-table-column label="æ“ä½œ" width="200">
                            <template #default="scope">
                                <el-button size="small" @click="showCategoryDialog(scope.row)">ç¼–è¾‘</el-button>
                                <el-button size="small" type="danger" @click="deleteCategory(scope.row)">åˆ é™¤</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>

                <!-- åº“å­˜è®°å½• -->
                <el-tab-pane label="åº“å­˜è®°å½•" name="logs">
                    <template #label>
                        <span><i class="el-icon-document"></i> åº“å­˜è®°å½•</span>
                    </template>

                    <div v-if="stockLogs.length > 0">
                        <div v-for="log in stockLogs" :key="log.id" class="log-item">
                            <div :class="['log-icon', log.change_amount > 0 ? 'log-in' : 'log-out']">
                                {{ log.change_amount > 0 ? 'ğŸ“¥' : 'ğŸ“¤' }}
                            </div>
                            <div class="log-content">
                                <div class="log-title">
                                    <span v-if="log.component">{{ log.component.name }}</span>
                                    <el-tag :type="log.change_amount > 0 ? 'success' : 'danger'" size="small" style="margin-left: 10px;">
                                        {{ log.change_amount > 0 ? '+' : '' }}{{ log.change_amount }}
                                    </el-tag>
                                </div>
                                <div class="log-meta">
                                    {{ log.reason || 'æ— å¤‡æ³¨' }} Â· {{ formatDate(log.created_at) }}
                                </div>
                            </div>
                        </div>

                        <el-pagination
                            @current-change="handleLogPageChange"
                            :current-page="logPagination.page"
                            :page-size="logPagination.pageSize"
                            :total="logPagination.total"
                            layout="total, prev, pager, next"
                            style="margin-top: 20px; text-align: right;">
                        </el-pagination>
                    </div>
                    <div v-else class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>æš‚æ— åº“å­˜è®°å½•</p>
                    </div>
                </el-tab-pane>
            </el-tabs>
        </div>

        <!-- å…ƒä»¶è¡¨å•å¯¹è¯æ¡† -->
        <el-dialog 
            v-model="componentDialogVisible" 
            :title="componentForm.id ? 'ç¼–è¾‘å…ƒä»¶' : 'æ·»åŠ å…ƒä»¶'"
            width="600px">
            
            <!-- å¹³å°å¯¼å…¥åŒºåŸŸ (ä»…åœ¨æ·»åŠ æ—¶æ˜¾ç¤º) -->
            <el-alert 
                v-if="!componentForm.id && supportedPlatforms.length > 0"
                title="ğŸ’¡ æç¤ºï¼šå¯ä»¥ä»å¹³å°å¿«é€Ÿå¯¼å…¥å…ƒä»¶ä¿¡æ¯"
                type="info"
                :closable="false"
                style="margin-bottom: 20px;">
                <template #default>
                    <div class="platform-import-box" style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                        <el-input 
                            v-model="platformCode" 
                            placeholder="è¾“å…¥å¹³å°ç¼–ç ï¼ˆå¦‚ï¼šC2040ï¼‰"
                            style="flex: 1;"
                            @keyup.enter="parseFromPlatform">
                            <template #prepend>
                                <span>ğŸ”</span>
                            </template>
                        </el-input>
                        <el-button 
                            type="primary" 
                            @click="parseFromPlatform"
                            :loading="platformParsing">
                            {{ platformParsing ? 'è§£æä¸­...' : 'è§£æ' }}
                        </el-button>
                        <el-button 
                            type="success" 
                            @click="openQRScanner">
                            ğŸ“· æ‰«ç 
                        </el-button>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #909399;">
                        æ”¯æŒå¹³å°: {{ supportedPlatforms.join('ã€') }} | æ”¯æŒäºŒç»´ç æ‰«æ
                    </div>
                </template>
            </el-alert>

            <el-form :model="componentForm" label-width="100px">
                <el-form-item label="åˆ†ç±»" required>
                    <el-select v-model="componentForm.category_id" placeholder="è¯·é€‰æ‹©åˆ†ç±»" style="width: 100%;">
                        <el-option v-for="cat in categories" :key="cat.id" :label="cat.name" :value="cat.id"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item label="å…ƒä»¶åç§°" required>
                    <el-input v-model="componentForm.name" placeholder="ä¾‹å¦‚: ESP32-WROOM-32"></el-input>
                </el-form-item>
                <el-form-item label="å‚æ•°å€¼">
                    <el-input v-model="componentForm.value" placeholder="ä¾‹å¦‚: 10kÎ©, 100nF"></el-input>
                </el-form-item>
                <el-form-item label="å°è£…">
                    <el-input v-model="componentForm.package" placeholder="ä¾‹å¦‚: 0805, SOP-8"></el-input>
                </el-form-item>
                <el-form-item label="åº“å­˜æ•°é‡" required>
                    <el-input-number v-model="componentForm.stock_quantity" :min="0" style="width: 100%;"></el-input-number>
                </el-form-item>
                <el-form-item label="å­˜æ”¾ä½ç½®">
                    <el-input v-model="componentForm.location" placeholder="ä¾‹å¦‚: A-1, ç›’å­B"></el-input>
                </el-form-item>
                <el-form-item label="æè¿°">
                    <el-input 
                        v-model="componentForm.description" 
                        type="textarea" 
                        :rows="3"
                        placeholder="å…ƒä»¶çš„è¯¦ç»†æè¿°">
                    </el-input>
                </el-form-item>
                <el-form-item label="æ•°æ®æ‰‹å†Œ">
                    <el-input v-model="componentForm.datasheet_url" placeholder="æ•°æ®æ‰‹å†Œ URL"></el-input>
                </el-form-item>
                <el-form-item label="å›¾ç‰‡ URL">
                    <el-input v-model="componentForm.image_url" placeholder="å›¾ç‰‡ URL"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="componentDialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="saveComponent">ä¿å­˜</el-button>
            </template>
        </el-dialog>

        <!-- åˆ†ç±»è¡¨å•å¯¹è¯æ¡† -->
        <el-dialog 
            v-model="categoryDialogVisible" 
            :title="categoryForm.id ? 'ç¼–è¾‘åˆ†ç±»' : 'æ·»åŠ åˆ†ç±»'"
            width="500px">
            <el-form :model="categoryForm" label-width="100px">
                <el-form-item label="åˆ†ç±»åç§°" required>
                    <el-input v-model="categoryForm.name" placeholder="ä¾‹å¦‚: ç”µé˜», ç”µå®¹, å¾®æ§åˆ¶å™¨"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="categoryDialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="saveCategory">ä¿å­˜</el-button>
            </template>
        </el-dialog>

        <!-- åº“å­˜æ“ä½œå¯¹è¯æ¡† -->
        <el-dialog 
            v-model="stockDialogVisible" 
            title="åº“å­˜å˜æ›´"
            width="500px">
            <div v-if="currentComponent">
                <el-alert 
                    :title="`å½“å‰åº“å­˜: ${currentComponent.stock_quantity}`" 
                    type="info" 
                    :closable="false"
                    style="margin-bottom: 20px;">
                </el-alert>
                <el-form :model="stockForm" label-width="100px">
                    <el-form-item label="æ“ä½œç±»å‹" required>
                        <el-radio-group v-model="stockForm.type">
                            <el-radio-button label="in">å…¥åº“</el-radio-button>
                            <el-radio-button label="out">å‡ºåº“</el-radio-button>
                        </el-radio-group>
                    </el-form-item>
                    <el-form-item label="æ•°é‡" required>
                        <el-input-number 
                            v-model="stockForm.amount" 
                            :min="1" 
                            :max="stockForm.type === 'out' ? currentComponent.stock_quantity : 999999"
                            style="width: 100%;">
                        </el-input-number>
                    </el-form-item>
                    <el-form-item label="å¤‡æ³¨">
                        <el-input 
                            v-model="stockForm.reason" 
                            type="textarea" 
                            :rows="3"
                            placeholder="ä¾‹å¦‚: é‡‡è´­ã€é¡¹ç›®ä½¿ç”¨ç­‰">
                        </el-input>
                    </el-form-item>
                </el-form>
            </div>
            <template #footer>
                <el-button @click="stockDialogVisible = false">å–æ¶ˆ</el-button>
                <el-button type="primary" @click="updateStock">ç¡®è®¤</el-button>
            </template>
        </el-dialog>

        <!-- åº“å­˜è®°å½•å¯¹è¯æ¡† -->
        <el-dialog 
            v-model="logsDialogVisible" 
            title="åº“å­˜è®°å½•"
            width="600px">
            <div v-if="componentLogs.length > 0">
                <div v-for="log in componentLogs" :key="log.id" class="log-item">
                    <div :class="['log-icon', log.change_amount > 0 ? 'log-in' : 'log-out']">
                        {{ log.change_amount > 0 ? 'ğŸ“¥' : 'ğŸ“¤' }}
                    </div>
                    <div class="log-content">
                        <div class="log-title">
                            <el-tag :type="log.change_amount > 0 ? 'success' : 'danger'" size="small">
                                {{ log.change_amount > 0 ? '+' : '' }}{{ log.change_amount }}
                            </el-tag>
                        </div>
                        <div class="log-meta">
                            {{ log.reason || 'æ— å¤‡æ³¨' }} Â· {{ formatDate(log.created_at) }}
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <p>æš‚æ— è®°å½•</p>
            </div>
        </el-dialog>

        <!-- äºŒç»´ç æ‰«æå¯¹è¯æ¡† -->
        <el-dialog 
            v-model="qrScannerDialogVisible" 
            title="ğŸ“· æ‰«æäºŒç»´ç "
            width="600px"
            @close="closeQRScanner">
            <div class="qrcode-scanner">
                <el-alert 
                    title="æ‰«æç«‹åˆ›å•†åŸå…ƒä»¶äºŒç»´ç ï¼Œè‡ªåŠ¨è¯†åˆ«å…ƒä»¶ä¿¡æ¯å’Œæ•°é‡"
                    type="info"
                    :closable="false"
                    style="margin-bottom: 20px;">
                </el-alert>

                <!-- äºŒç»´ç æ‰«æåŒºåŸŸ -->
                <div id="qr-reader" style="width: 100%;"></div>

                <!-- æ‰«æç»“æœæ˜¾ç¤º -->
                <div v-if="qrScanResult" style="margin-top: 20px;">
                    <el-alert 
                        title="æ‰«ææˆåŠŸï¼"
                        type="success"
                        :closable="false">
                        <template #default>
                            <div style="font-size: 14px; margin-top: 10px;">
                                <strong>æ‰«æå†…å®¹ï¼š</strong>{{ qrScanResult }}
                            </div>
                        </template>
                    </el-alert>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="scanner-actions">
                    <el-button 
                        v-if="!qrScanning" 
                        type="primary" 
                        @click="startQRScanner">
                        å¼€å§‹æ‰«æ
                    </el-button>
                    <el-button 
                        v-if="qrScanning" 
                        type="danger" 
                        @click="stopQRScanner">
                        åœæ­¢æ‰«æ
                    </el-button>
                    <el-upload
                        :show-file-list="false"
                        :before-upload="handleQRImageUpload"
                        accept="image/*">
                        <el-button type="info">ä¸Šä¼ å›¾ç‰‡</el-button>
                    </el-upload>
                </div>
            </div>
            <template #footer>
                <el-button @click="closeQRScanner">å…³é—­</el-button>
            </template>
        </el-dialog>
    </div>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Axios -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'components',
                    loading: false,
                    
                    // ç»Ÿè®¡æ•°æ®
                    stats: {
                        totalComponents: 0,
                        totalStock: 0,
                        categories: 0
                    },

                    // åˆ†ç±»
                    categories: [],
                    categoryDialogVisible: false,
                    categoryForm: {
                        id: null,
                        name: ''
                    },

                    // å…ƒä»¶
                    components: [],
                    componentDialogVisible: false,
                    componentForm: {
                        id: null,
                        category_id: null,
                        name: '',
                        value: '',
                        package: '',
                        description: '',
                        stock_quantity: 0,
                        location: '',
                        datasheet_url: '',
                        image_url: ''
                    },
                    componentSearch: {
                        keyword: '',
                        categoryId: null
                    },
                    componentPagination: {
                        page: 1,
                        pageSize: 20,
                        total: 0
                    },

                    // åº“å­˜æ“ä½œ
                    stockDialogVisible: false,
                    currentComponent: null,
                    stockForm: {
                        type: 'in',
                        amount: 1,
                        reason: ''
                    },

                    // åº“å­˜è®°å½•
                    stockLogs: [],
                    logPagination: {
                        page: 1,
                        pageSize: 20,
                        total: 0
                    },

                    // å…ƒä»¶åº“å­˜è®°å½•
                    logsDialogVisible: false,
                    componentLogs: [],

                    // å¹³å°å¯¼å…¥
                    platformCode: '',
                    platformParsing: false,
                    supportedPlatforms: [],

                    // äºŒç»´ç æ‰«æ
                    qrScannerDialogVisible: false,
                    qrScanning: false,
                    qrScanner: null,
                    qrScanResult: ''
                };
            },
            mounted() {
                this.loadCategories();
                this.loadComponents();
                this.loadStockLogs();
                this.loadSupportedPlatforms();
            },
            methods: {
                // API åŸºç¡€åœ°å€
                apiUrl(path) {
                    return `/api/v1${path}`;
                },

                // åŠ è½½åˆ†ç±»
                async loadCategories() {
                    try {
                        const response = await axios.get(this.apiUrl('/categories'));
                        this.categories = response.data.data || [];
                        this.stats.categories = this.categories.length;
                    } catch (error) {
                        this.$message.error('åŠ è½½åˆ†ç±»å¤±è´¥: ' + error.message);
                    }
                },

                // æ˜¾ç¤ºåˆ†ç±»å¯¹è¯æ¡†
                showCategoryDialog(category) {
                    if (category) {
                        this.categoryForm = { ...category };
                    } else {
                        this.categoryForm = { id: null, name: '' };
                    }
                    this.categoryDialogVisible = true;
                },

                // ä¿å­˜åˆ†ç±»
                async saveCategory() {
                    if (!this.categoryForm.name) {
                        this.$message.warning('è¯·è¾“å…¥åˆ†ç±»åç§°');
                        return;
                    }

                    try {
                        if (this.categoryForm.id) {
                            await axios.put(this.apiUrl(`/categories/${this.categoryForm.id}`), this.categoryForm);
                            this.$message.success('æ›´æ–°æˆåŠŸ');
                        } else {
                            await axios.post(this.apiUrl('/categories'), this.categoryForm);
                            this.$message.success('æ·»åŠ æˆåŠŸ');
                        }
                        this.categoryDialogVisible = false;
                        this.loadCategories();
                    } catch (error) {
                        this.$message.error('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                },

                // åˆ é™¤åˆ†ç±»
                async deleteCategory(category) {
                    try {
                        await this.$confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±» "${category.name}" å—ï¼Ÿ`, 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        await axios.delete(this.apiUrl(`/categories/${category.id}`));
                        this.$message.success('åˆ é™¤æˆåŠŸ');
                        this.loadCategories();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('åˆ é™¤å¤±è´¥: ' + error.message);
                        }
                    }
                },

                // åŠ è½½å…ƒä»¶
                async loadComponents() {
                    this.loading = true;
                    try {
                        const params = {
                            page: this.componentPagination.page,
                            page_size: this.componentPagination.pageSize
                        };
                        
                        if (this.componentSearch.keyword) {
                            params.keyword = this.componentSearch.keyword;
                        }
                        if (this.componentSearch.categoryId) {
                            params.category_id = this.componentSearch.categoryId;
                        }

                        const response = await axios.get(this.apiUrl('/components'), { params });
                        this.components = response.data.data || [];
                        this.componentPagination.total = response.data.pagination?.total || 0;

                        // æ›´æ–°ç»Ÿè®¡
                        this.stats.totalComponents = this.componentPagination.total;
                        this.stats.totalStock = this.components.reduce((sum, c) => sum + c.stock_quantity, 0);
                    } catch (error) {
                        this.$message.error('åŠ è½½å…ƒä»¶å¤±è´¥: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },

                // æ˜¾ç¤ºå…ƒä»¶å¯¹è¯æ¡†
                showComponentDialog(component) {
                    if (component) {
                        this.componentForm = { ...component };
                    } else {
                        this.componentForm = {
                            id: null,
                            category_id: null,
                            name: '',
                            value: '',
                            package: '',
                            description: '',
                            stock_quantity: 0,
                            location: '',
                            datasheet_url: '',
                            image_url: ''
                        };
                    }
                    this.componentDialogVisible = true;
                },

                // ä¿å­˜å…ƒä»¶
                async saveComponent() {
                    if (!this.componentForm.name || !this.componentForm.category_id) {
                        this.$message.warning('è¯·å¡«å†™å¿…å¡«é¡¹');
                        return;
                    }

                    try {
                        if (this.componentForm.id) {
                            await axios.put(this.apiUrl(`/components/${this.componentForm.id}`), this.componentForm);
                            this.$message.success('æ›´æ–°æˆåŠŸ');
                        } else {
                            await axios.post(this.apiUrl('/components'), this.componentForm);
                            this.$message.success('æ·»åŠ æˆåŠŸ');
                        }
                        this.componentDialogVisible = false;
                        this.loadComponents();
                    } catch (error) {
                        this.$message.error('ä¿å­˜å¤±è´¥: ' + error.message);
                    }
                },

                // åˆ é™¤å…ƒä»¶
                async deleteComponent(component) {
                    try {
                        await this.$confirm(`ç¡®å®šè¦åˆ é™¤å…ƒä»¶ "${component.name}" å—ï¼Ÿ`, 'æç¤º', {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        });

                        await axios.delete(this.apiUrl(`/components/${component.id}`));
                        this.$message.success('åˆ é™¤æˆåŠŸ');
                        this.loadComponents();
                    } catch (error) {
                        if (error !== 'cancel') {
                            this.$message.error('åˆ é™¤å¤±è´¥: ' + error.message);
                        }
                    }
                },

                // æ˜¾ç¤ºåº“å­˜å¯¹è¯æ¡†
                showStockDialog(component) {
                    this.currentComponent = component;
                    this.stockForm = {
                        type: 'in',
                        amount: 1,
                        reason: ''
                    };
                    this.stockDialogVisible = true;
                },

                // æ›´æ–°åº“å­˜
                async updateStock() {
                    if (!this.stockForm.amount || this.stockForm.amount <= 0) {
                        this.$message.warning('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°é‡');
                        return;
                    }

                    try {
                        const amount = this.stockForm.type === 'in' ? this.stockForm.amount : -this.stockForm.amount;
                        await axios.post(this.apiUrl(`/components/${this.currentComponent.id}/stock`), {
                            amount: amount,
                            reason: this.stockForm.reason
                        });
                        
                        this.$message.success('åº“å­˜æ›´æ–°æˆåŠŸ');
                        this.stockDialogVisible = false;
                        this.loadComponents();
                        this.loadStockLogs();
                    } catch (error) {
                        this.$message.error('æ›´æ–°å¤±è´¥: ' + error.message);
                    }
                },

                // æ˜¾ç¤ºåº“å­˜è®°å½•
                async showLogsDialog(component) {
                    this.currentComponent = component;
                    this.logsDialogVisible = true;
                    
                    try {
                        const response = await axios.get(this.apiUrl(`/components/${component.id}/logs`));
                        this.componentLogs = response.data.data || [];
                    } catch (error) {
                        this.$message.error('åŠ è½½è®°å½•å¤±è´¥: ' + error.message);
                    }
                },

                // åŠ è½½åº“å­˜è®°å½•
                async loadStockLogs() {
                    try {
                        const response = await axios.get(this.apiUrl('/stock-logs'), {
                            params: {
                                page: this.logPagination.page,
                                page_size: this.logPagination.pageSize
                            }
                        });
                        this.stockLogs = response.data.data || [];
                        this.logPagination.total = response.data.pagination?.total || 0;
                    } catch (error) {
                        console.error('åŠ è½½åº“å­˜è®°å½•å¤±è´¥:', error);
                    }
                },

                // åˆ†é¡µå¤„ç†
                handlePageChange(page) {
                    this.componentPagination.page = page;
                    this.loadComponents();
                },

                handleSizeChange(size) {
                    this.componentPagination.pageSize = size;
                    this.componentPagination.page = 1;
                    this.loadComponents();
                },

                handleLogPageChange(page) {
                    this.logPagination.page = page;
                    this.loadStockLogs();
                },

                // åº“å­˜ç­‰çº§æ ·å¼
                getStockClass(quantity) {
                    if (quantity >= 50) return 'stock-badge stock-high';
                    if (quantity >= 10) return 'stock-badge stock-medium';
                    return 'stock-badge stock-low';
                },

                // æ ¼å¼åŒ–æ—¥æœŸ
                formatDate(dateString) {
                    if (!dateString) return '-';
                    const date = new Date(dateString);
                    const now = new Date();
                    const diff = now - date;
                    
                    // å°äº1åˆ†é’Ÿ
                    if (diff < 60000) return 'åˆšåˆš';
                    // å°äº1å°æ—¶
                    if (diff < 3600000) return Math.floor(diff / 60000) + 'åˆ†é’Ÿå‰';
                    // å°äº1å¤©
                    if (diff < 86400000) return Math.floor(diff / 3600000) + 'å°æ—¶å‰';
                    // å°äº7å¤©
                    if (diff < 604800000) return Math.floor(diff / 86400000) + 'å¤©å‰';
                    
                    // è¶…è¿‡7å¤©æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                // åŠ è½½æ”¯æŒçš„å¹³å°åˆ—è¡¨
                async loadSupportedPlatforms() {
                    try {
                        const response = await axios.get(this.apiUrl('/platforms'));
                        this.supportedPlatforms = response.data.data || [];
                    } catch (error) {
                        console.error('åŠ è½½å¹³å°åˆ—è¡¨å¤±è´¥:', error);
                    }
                },

                // ä»å¹³å°è§£æå…ƒä»¶ä¿¡æ¯
                async parseFromPlatform() {
                    if (!this.platformCode) {
                        this.$message.warning('è¯·è¾“å…¥å¹³å°ç¼–ç ');
                        return;
                    }

                    this.platformParsing = true;
                    try {
                        const response = await axios.post(this.apiUrl('/components/parse'), {
                            code: this.platformCode
                        });
                        
                        const data = response.data.data;
                        this.fillComponentForm(data);
                        
                        this.$message.success('è§£ææˆåŠŸï¼å·²è‡ªåŠ¨å¡«å……å…ƒä»¶ä¿¡æ¯');
                        this.platformCode = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    } catch (error) {
                        const msg = error.response?.data?.error || error.message || 'è§£æå¤±è´¥';
                        this.$message.error(msg);
                    } finally {
                        this.platformParsing = false;
                    }
                },

                // å¡«å……å…ƒä»¶è¡¨å•ï¼ˆé€šç”¨æ–¹æ³•ï¼‰
                fillComponentForm(data, quantity) {
                    // è‡ªåŠ¨å¡«å……è¡¨å•
                    this.componentForm.name = data.name || data.model || '';
                    this.componentForm.value = data.value || '';
                    this.componentForm.package = data.package || '';
                    this.componentForm.description = data.description || '';
                    this.componentForm.datasheet_url = data.datasheet_url || '';
                    this.componentForm.image_url = data.image_url || '';
                    
                    // å¦‚æœæä¾›äº†æ•°é‡ï¼Œè®¾ç½®åº“å­˜æ•°é‡
                    if (quantity && quantity > 0) {
                        this.componentForm.stock_quantity = quantity;
                    }
                    
                    // å¦‚æœæœ‰åˆ¶é€ å•†ä¿¡æ¯ï¼Œæ·»åŠ åˆ°æè¿°ä¸­
                    if (data.manufacturer) {
                        const mfgInfo = `åˆ¶é€ å•†: ${data.manufacturer}`;
                        if (this.componentForm.description) {
                            this.componentForm.description += '\n' + mfgInfo;
                        } else {
                            this.componentForm.description = mfgInfo;
                        }
                    }
                    
                    // å¦‚æœæœ‰å¹³å°é“¾æ¥ï¼Œæ·»åŠ åˆ°æè¿°ä¸­
                    if (data.platform_url) {
                        const linkInfo = `${data.platform_name}é“¾æ¥: ${data.platform_url}`;
                        if (this.componentForm.description) {
                            this.componentForm.description += '\n' + linkInfo;
                        } else {
                            this.componentForm.description = linkInfo;
                        }
                    }
                },

                // æ‰“å¼€äºŒç»´ç æ‰«æå™¨
                openQRScanner() {
                    this.qrScannerDialogVisible = true;
                    this.qrScanResult = '';
                },

                // å¼€å§‹äºŒç»´ç æ‰«æ
                async startQRScanner() {
                    try {
                        if (!this.qrScanner) {
                            this.qrScanner = new Html5Qrcode("qr-reader");
                        }

                        this.qrScanning = true;
                        
                        // å“åº”å¼æ‰«ææ¡†é…ç½®
                        const qrboxFunction = (viewfinderWidth, viewfinderHeight) => {
                            const minEdgePercentage = 0.7; // 70%
                            const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                            const qrboxSize = Math.floor(minEdge * minEdgePercentage);
                            return {
                                width: qrboxSize,
                                height: qrboxSize
                            };
                        };
                        
                        await this.qrScanner.start(
                            { facingMode: "environment" }, // ä½¿ç”¨åç½®æ‘„åƒå¤´
                            {
                                fps: 10,
                                qrbox: qrboxFunction
                            },
                            this.onQRCodeScanned,
                            this.onQRCodeScanError
                        );
                    } catch (err) {
                        console.error('å¯åŠ¨æ‰«æå™¨å¤±è´¥:', err);
                        
                        let msg = 'æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™æˆ–å°è¯•ä¸Šä¼ å›¾ç‰‡';
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯éå®‰å…¨ä¸Šä¸‹æ–‡å¯¼è‡´çš„é—®é¢˜
                        if (location.protocol !== 'https:' && 
                            location.hostname !== 'localhost' && 
                            location.hostname !== '127.0.0.1') {
                            msg = 'âš ï¸ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼šæµè§ˆå™¨å®‰å…¨ç­–ç•¥é™åˆ¶åœ¨é HTTPS ç¯å¢ƒä¸‹è®¿é—®æ‘„åƒå¤´ã€‚è¯·ä½¿ç”¨ localhost è®¿é—®æˆ–é…ç½® HTTPSï¼Œæˆ–å°è¯•"ä¸Šä¼ å›¾ç‰‡"åŠŸèƒ½ã€‚';
                        } else if (err.name === 'NotAllowedError') {
                            msg = 'âš ï¸ æ‘„åƒå¤´æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®æ‘„åƒå¤´ã€‚';
                        } else if (err.name === 'NotFoundError') {
                            msg = 'âš ï¸ æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡ã€‚';
                        }
                        
                        this.$message.error({
                            message: msg,
                            duration: 5000,
                            showClose: true
                        });
                        this.qrScanning = false;
                    }
                },

                // åœæ­¢äºŒç»´ç æ‰«æ
                async stopQRScanner() {
                    if (this.qrScanner && this.qrScanning) {
                        try {
                            await this.qrScanner.stop();
                            this.qrScanning = false;
                        } catch (err) {
                            console.error('åœæ­¢æ‰«æå™¨å¤±è´¥:', err);
                        }
                    }
                },

                // å…³é—­äºŒç»´ç æ‰«æå™¨
                async closeQRScanner() {
                    await this.stopQRScanner();
                    this.qrScannerDialogVisible = false;
                    this.qrScanResult = '';
                },

                // æ‰«ææˆåŠŸå›è°ƒ
                async onQRCodeScanned(decodedText, decodedResult) {
                    this.qrScanResult = decodedText;
                    await this.stopQRScanner();
                    
                    // è§£æäºŒç»´ç å†…å®¹
                    await this.parseQRCode(decodedText);
                },

                // æ‰«æé”™è¯¯å›è°ƒï¼ˆé™é»˜å¤„ç†ï¼‰
                onQRCodeScanError(error) {
                    // æ‰«æè¿‡ç¨‹ä¸­çš„é”™è¯¯å¯ä»¥å¿½ç•¥
                },

                // å¤„ç†ä¸Šä¼ çš„äºŒç»´ç å›¾ç‰‡
                async handleQRImageUpload(file) {
                    try {
                        if (!this.qrScanner) {
                            this.qrScanner = new Html5Qrcode("qr-reader");
                        }

                        const result = await this.qrScanner.scanFile(file, true);
                        this.qrScanResult = result;
                        await this.parseQRCode(result);
                    } catch (err) {
                        console.error('è§£æå›¾ç‰‡å¤±è´¥:', err);
                        this.$message.error('æ— æ³•è¯†åˆ«å›¾ç‰‡ä¸­çš„äºŒç»´ç ');
                    }
                    
                    return false; // é˜»æ­¢è‡ªåŠ¨ä¸Šä¼ 
                },

                // è§£æäºŒç»´ç å†…å®¹å¹¶è·å–å…ƒä»¶ä¿¡æ¯
                async parseQRCode(qrcodeData) {
                    try {
                        const response = await axios.post(this.apiUrl('/components/parse-qrcode'), {
                            qrcode_data: qrcodeData
                        });
                        
                        const data = response.data.data;
                        const component = data.component;
                        const quantity = data.quantity || 1;
                        const qrcodeInfo = data.qrcode_info;
                        
                        // å¡«å……è¡¨å•
                        this.fillComponentForm(component, quantity);
                        
                        // å…³é—­æ‰«æå¯¹è¯æ¡†
                        this.closeQRScanner();
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        this.$message.success(
                            `è§£ææˆåŠŸï¼å…ƒä»¶: ${component.name}, æ•°é‡: ${quantity}`
                        );
                    } catch (error) {
                        const msg = error.response?.data?.error || error.message || 'è§£æäºŒç»´ç å¤±è´¥';
                        this.$message.error(msg);
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
